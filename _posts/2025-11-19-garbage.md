---
layout: post
title: "Garbage"
date: 2025-11-19
---

## Garbage

So you thought you'd do a migration, or maybe you've done a little more repl'ing than you wish you did, and you've 
gone and removed an attribute from a schema while it was still storing data, and it had data on it, but now... 
it has garbage!

I think many people just scrap the whole database (hopefully you're only doing cavalier repl'ing on localhost.. right?) 
and just start fresh. But, what if you've painstakingly entered in data that you have gotten quite used to having 
around and don't really care to scrap it all, but also don't want to be haunted by garbage?
(Yes, I'm certain you'll get around to updating the seed to have all the data you expect to be present on a fresh start, 
that will be good to do too!)

One neat option you might have if using the datomic database is the use of history. It just keeps a history! That's 
pretty cool, and until now I've never really cared about it, but today, I like it quite well. 

If you want to try a little recovery of the data that you turned into garbage, your repl will need a couple dependencies: 
```
(require '[c3kit.bucket.api :as db])
(require '[c3kit.bucket.datomic :as datomic])
```
Let's say you deleted :xp from the apprentice entity. Any apprentice will tell you they need all that xp back right now! 

We have to do a little perusal first. When the field is removed, datomic renames it and adds the milliseconds 
since-epoch to it (the exact moment of your mess-up, now memorialized in all of your database history that you didn't 
even know to worry about until just now, excellent.) 

If you know of a specific entity that had the field, or if all of them did, then just one will do: 
Be warned, if you don't limit it to the last couple, this would print the entire history of this entity, so if it's 
been altered a lot, there may be excessive scrolling.
```
(println (take-last 2  (datomic/history (db/ffind :apprentice))))
```
Feel free to pretty print if you like, especially if you need to take a sampling, but we're really just looking for 
what the :xp field got renamed to. For me, it was `:apprentice.xp_1763598604762`. 

Then, you just need to grab all the relevant data (not all of my entities had xp, so the `:when` may be optional 
for you: 

```
(def xp-to-restore
  (for [apprentice (db/find :apprentice)
      :let [xp-value (get-xp apprentice)]
      :when xp-value]
        [(:id apprentice) xp-value]))
```
I liked having the data collection step separate from the modification step, because then I could run the above method 
and see the data I had captured and get a sense of if this was doing what I expected. 

Finally, reconstruct and save your data!

```
(doseq [[apprentice-id xp] xp-to-restore]
  (db/tx (assoc (db/entity apprentice-id) :apprentice/xp xp)))
```

Ok, Now that you know that your data is recoverable with a bit of digging, I'm not sure if you should feel like you 
can repl with even more wild-abandon, or if knowing how much work you'll have to do to undo it will make you more 
careful, but I'm at least appreciative that there's some way to do an 'Undo'!

**Cheers!**